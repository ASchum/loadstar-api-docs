# Архитектура и описание работы системы LoadStar

**Дата документа:** 05.02.2026  
**Версия:** 1.0

---

## Содержание
1. [Общая архитектура системы](#1-общая-архитектура-системы)
2. [Бизнес-процессы](#2-бизнес-процессы)
3. [Основные сценарии использования](#3-основные-сценарии-использования)
4. [Технологический стек](#4-технологический-стек)
5. [Безопасность и доступ](#5-безопасность-и-доступ)
6. [Масштабируемость и производительность](#6-масштабируемость-и-производительность)
7. [REST API](#7-rest-api)
8. [Расписание разработки](#8-расписание-разработки-рекомендуемо)
9. [Заключение](#9-заключение)

---

## 1. Общая архитектура системы

### 1.1 Уровни архитектуры

```
┌─────────────────────────────────────────┐
│         Presentation Layer              │
│  (Веб-интерфейс / Frontend)             │
│  - Карточки (справочники)               │
│  - Запросы                              │
│  - Заказы                               │
│  - Отчеты                               │
│  - Управление пользователями            │
└─────────────────────────────────────────┘
                  │
                  ↓
         HTTP/HTTPS (API)
                  │
                  ↓
┌─────────────────────────────────────────┐
│       Application Layer (Backend)       │
│  - API endpoints                        │
│  - Business Logic                       │
│  - Validation & Authorization           │
│  - File Management                      │
│  - Reporting Engine                     │
└─────────────────────────────────────────┘
                  │
                  ↓
         Database Driver (MySQL)
                  │
                  ↓
┌─────────────────────────────────────────┐
│       Data Layer (Database)             │
│  - MySQL 8.0+                           │
│  - 17 таблиц                            │
│  - Индексы на часто используемые поля  │
│  - Внешние ключи для целостности        │
└─────────────────────────────────────────┘
```

### 1.2 Компоненты системы

#### Frontend (Веб-интерфейс)
- **Технология:** (уточнить на следующем этапе)
- **Функции:**
  - Управление карточками (клиенты, контрагенты, пользователи)
  - Создание и редактирование запросов
  - Согласование маршрутов (чат-интерфейс)
  - Управление заказами и финансами
  - Формирование отчетов
  - Управление справочниками (Admin)

#### Backend (API)
- **Технология:** (уточнить на следующем этапе)
- **Функции:**
  - REST/GraphQL API endpoints
  - Аутентификация и авторизация (RBAC)
  - Валидация данных
  - Бизнес-логика процессов
  - Управление файлами
  - Генерация счетов и отчетов
  - Логирование операций

#### Database (БД)
- **СУБД:** MySQL 8.0+
- **Кодировка:** UTF-8MB4 (поддержка Unicode)
- **Количество таблиц:** 17
- **Объем данных:** до 36,000 записей в год (1000 запросов/заказов + 3000 документов в месяц)

---

## 2. Бизнес-процессы

### 2.1 Процесс 1: Управление справочниками (Карточки)

```
Admin (Администратор)
  │
  ├─ Управление пользователями
  │  ├─ Добавление нового
  │  ├─ Редактирование
  │  ├─ Деактивация
  │  └─ Сброс пароля
  │
  ├─ Управление справочниками
  │  ├─ Города
  │  ├─ Услуги доставки
  │  ├─ Типы ТС (20DC, 40HC и т.д.)
  │  ├─ Валюты (USD, EUR, CNY, RUB)
  │  ├─ Условия Incoterms
  │  └─ Другие справочники
  │
Ops / Supervisor
  │
  ├─ Управление контрагентами
  │  ├─ Поиск по наименованию / ИНН / городу
  │  ├─ Добавление нового
  │  ├─ Редактирование данных
  │  ├─ Управление договорами
  │  ├─ Управление контактными лицами
  │  └─ Деактивация
  │
  ├─ Управление клиентами
  │  ├─ Поиск по наименованию / ИНН / городу
  │  ├─ Добавление нового
  │  ├─ Редактирование данных
  │  ├─ Управление контактами и ЛПР
  │  ├─ Управление банковскими реквизитами
  │  └─ Деактивация
```

### 2.2 Процесс 2: Создание и согласование запроса (Sales + Leid → Заказ)

```
Sales Менеджер
  │
  ├─ Создание нового запроса
  │  ├─ Выбор типа: "Запрос от Sales с Лидом"
  │  ├─ Ввод / выбор Лида (client.status='Lead')
  │  ├─ Ввод Данных Запроса (Incoterms, отправитель, получатель, груз и т.д.)
  │  ├─ Ввод пожеланий Лида (комментарий, файлы)
  │  └─ Сохранение запроса в статусе "New"
  │
  ├─ Варианты согласования маршрута:
  │  ├─ ВАРИАНТ А: Прямой переход (если маршрут готов)
  │  │  ├─ Sales заполняет route_stage самостоятельно
  │  │  └─ Переводит запрос: New → Approved (без согласования)
  │  │
  │  └─ ВАРИАНТ Б: Через согласование с Logist
  │     ├─ Sales переводит запрос: New → Negotiating
  │     ├─ Заполняет комментарий и загружает файлы
  │     ├─ Отправляет сообщение в чат (route_negotiation)
  │     ├─ Logist отвечает с уточнениями
  │     └─ После согласования Sales переводит: Negotiating → Approved
  │
  ├─ Построение итогового маршрута (route_stage)
  │  ├─ Добавление этапов маршрута:
  │  │  ├─ Departure - отправка (начальная точка)
  │  │  ├─ Delivery - доставка (промежуточные этапы)
  │  │  ├─ Reloading - перегрузка (опционально)
  │  │  ├─ Customs - таможня (опционально)
  │  │  └─ Warehouse - склад (финальная точка)
  │  ├─ Для каждого этапа:
  │  │  ├─ Указание места (from_place, to_place)
  │  │  ├─ Ввод плановых дат (planned_departure_date, planned_arrival_date)
  │  │  ├─ Выбор delivery_service, transport_unit_type
  │  │  ├─ Ввод стоимости (cost_amount, currency_id)
  │  │  └─ Порядок следования (stage_order: 1,2,3...)
  │  └─ Маршрут готов к выполнению
  │
  ├─ Автоматическая конвертация Лида в Клиента
  │  ├─ При переходе первого запроса в статус "Approved":
  │  │  ├─ Триггер обновляет: client.status = 'Lead' → 'Active'
  │  │  ├─ Заполняет client.converted_at = NOW()
  │  │  └─ Лид становится активным клиентом
  │  └─ Заполнение недостающих данных клиента:
  │     ├─ Банковские реквизиты (обязательны для выставления счетов)
  │     ├─ Полные реквизиты организации
  │     └─ Ведущий менеджер (Ops)
  │
  ├─ Запрос становится Заказом (request.status = 'Approved')
  │  ├─ Запрос со статусом Approved/Completed = заказ
  │  ├─ Привязка договоров через request_contract
  │  └─ Ops начинает сопровождение
  │
  └─ Сопровождение заказа
     └─ Ops ведет заказ до завершения

────────────────────────────────────────────────────────────

Logist (в параллель)
  │
  ├─ Уведомление о новом маршруте
  │  └─ Получает сообщение в чате от Sales/Ops
  │
  ├─ Ответ с уточнениями
  │  ├─ Отвечает в чате
  │  ├─ Может предложить альтернативы
  │  └─ Обсуждает сроки и условия
  │
  ├─ Согласование маршрута
  │  └─ Sales/Ops закрывает согласование
```

### 2.3 Процесс 3: Создание и согласование запроса (Ops + Client → Заказ)

```
Ops Оператор (очень похож на Process 2, но с существующим Клиентом)
  │
  ├─ Создание нового запроса
  │  ├─ Выбор типа: "Запрос от Ops с Клиентом"
  │  ├─ Поиск и выбор Клиента
  │  ├─ Ввод Данных Запроса
  │  ├─ Ввод пожеланий Клиента
  │  └─ Сохранение запроса
  │
  ├─ Инициация согласования маршрута (аналогично Sales)
  │
  ├─ Построение окончательного маршрута (аналогично Sales)
  │
  ├─ Формирование Заказа (аналогично Sales)
  │  └─ Клиент уже существует, не требуется конвертация Лида
  │
  └─ Сопровождение заказа
     └─ Ops продолжает работу с заказом (смотрите Process 4)
```

### 2.4 Процесс 4: Сопровождение Заказа

```
Ops Оператор
  │
  ├─ Ввод фактических дат по этапам маршрута
  │  ├─ При прохождении каждого этапа
  │  ├─ Ввод фактической даты отправления
  │  ├─ Ввод фактической даты прибытия
  │  └─ Система вычисляет: задержка / опережение
  │
  ├─ Загрузка документов
  │  ├─ Накладные
  │  ├─ Коносамент (BL)
  │  ├─ Таможенные декларации (ДТ)
  │  ├─ Счета-фактуры
  │  └─ Другие документы с описанием
  │
  ├─ Выставление счета Клиенту
  │  ├─ Создание счета клиенту (request_invoice, invoice_type='to_client')
  │  ├─ Указание номера и даты счета
  │  ├─ Отображение счета в окне (реквизиты клиента + услуги)
  │  └─ Статус proposal_status → "Agreed" (если согласовано)
  │
  ├─ Запрос счета у Контрагента
  │  ├─ Создание счета контрагенту (request_invoice, invoice_type='from_counterparty')
  │  ├─ Выбор контрагента
  │  ├─ Указание номера и даты счета
  │  └─ Отправка запроса
  │
  ├─ Ввод расходов и доходов
  │  ├─ Создание записей в request_financial_record
  │  ├─ Запись типа "Income" (доход от клиента)
  │  ├─ Запись типа "Expense" (расход на контрагентов)
  │  ├─ Вычисление итогов
  │  └─ Расчет прибыли/убытка
  │
  ├─ Получение подтверждения оплаты
  │  ├─ Заполнение номера счета
  │  ├─ Заполнение даты оплаты
  │  └─ Возможно добавление комментария (переплата/недоплата)
  │
  ├─ Запрос на изменение маршрута (при необходимости)
  │  ├─ Supervisor возвращает заказ на доработку:
  │  │  └─ request.status: Approved → Negotiating
  │  ├─ Ops вносит изменения в route_stage:
  │  │  ├─ Добавляет/удаляет/изменяет этапы
  │  │  ├─ Корректирует даты и стоимости
  │  │  └─ При необходимости согласовывает через route_negotiation
  │  └─ После согласования переводит обратно:
  │     └─ request.status: Negotiating → Approved
  │
  ├─ Завершение Заказа (только Supervisor)
  │  ├─ Supervisor проверяет:
  │  │  ├─ Все этапы выполнены (actual_dates заполнены)
  │  │  ├─ Финансы в порядке (счета оплачены)
  │  │  └─ Документы загружены
  │  ├─ Переводит: request.status = 'Approved' → 'Completed'
  │  ├─ Заполняется request.completed_at = NOW()
  │  └─ Заказ архивируется (больше не редактируется)
  │
  └─ Сопровождение завершено

────────────────────────────────────────────────────────────

Supervisor (контроль)
  │
  ├─ Мониторинг запросов
  │  ├─ Просмотр всех запросов (активные, завершенные)
  │  ├─ Контроль статусов
  │  └─ Возможность редактирования активного запроса
  │
  ├─ Мониторинг заказов
  │  ├─ Просмотр всех заказов
  │  ├─ Просмотр фактических дат (задержки/опережения)
  │  ├─ Просмотр финансовых данных
  │  └─ Возможность редактирования активного заказа
  │
  ├─ Утверждение запросов на изменение маршрута
  │  ├─ Получение запроса от Ops
  │  ├─ Разблокировка маршрута (is_final = false)
  │  ├─ Контроль изменений
  │  └─ Фиксация изменения условий оплаты (если нужно)
  │
  ├─ Утверждение завершения Заказа
  │  ├─ Получение запроса от Ops
  │  ├─ Проверка статуса прибытия
  │  ├─ Утверждение завершения
  │  └─ Заказ архивируется
  │
  ├─ Управление договорами
  │  ├─ Возможность редактирования условий оплаты
  │  ├─ Валидация дат договоров
  │  └─ Контроль сроков действия
  │
  └─ Формирование отчетов
     ├─ По менеджерам (Sales, Ops)
     ├─ По клиентам
     ├─ По контрагентам
     ├─ По направлениям доставки
     ├─ По периодам (дата создания, завершения)
     ├─ По финансовым показателям
     └─ Экспорт в CSV/Excel/PDF
```

---

## 3. Основные сценарии использования

### 3.1 Юзкейс 1: Sales инициирует запрос с новым Лидом

**Актеры:** Sales Manager, Logist, Supervisor  
**Предусловие:** Логин в систему выполнен  
**Основной поток:**

1. Sales выбирает "Создать новый запрос" типа "От Sales с Лидом"
2. Вводит данные Лида (контакт, компания, город и т.д.) или выбирает существующего
3. Заполняет Данные Запроса (Incoterms, отправитель, получатель, груз, таможня)
4. Вводит пожелания Лида (комментарий, загружает файлы)
5. Отправляет запрос на согласование маршрута (сообщение Logist)
6. Ожидает ответа от Logist (может быть несколько итераций в чате)
7. После согласования строит окончательный маршрут:
   - Добавляет этапы (доставка, перегрузка, таможня, склад)
   - Ввод плановых дат и сумм
   - Вычисление ставок клиента
   - Обозначение маршрута как окончательный
8. Переводит Лида в Клиента (заполнение банковских реквизитов)
9. Формирует Заказ (выбирает договор)
10. Передает Ops на сопровождение

**Альтернативные потоки:**
- Если маршрут не согласован, Sales может отредактировать запрос и переотправить
- Если Лид отказывается, запрос завершается с причиной "Отказано"

**Постусловие:** Запрос переведен в статус Approved (стал заказом), Лид конвертирован в Клиента

---

### 3.2 Юзкейс 2: Ops сопровождает Заказ (ввод фактических дат и финансов)

**Актеры:** Ops Manager, Supervisor  
**Предусловие:** Запрос в статусе Approved (= заказ)  
**Основной поток:**

1. Ops открывает запрос/заказ (request.status='Approved')
2. При прохождении каждого этапа маршрута (route_stage):
   - Вводит фактическую дату отправления (actual_departure_date)
   - Вводит фактическую дату прибытия (actual_arrival_date)
   - Система автоматически вычисляет задержку/опережение
3. Загружает документы в request_document (накладные, ДТ, счета-фактуры)
4. Выставляет счет Клиенту:
   - Создает request_invoice (тип invoice_type='to_client')
   - Система генерирует форму счета
5. Запрашивает счет у Контрагента:
   - Создает request_invoice (тип invoice_type='from_counterparty')
6. Вводит фактические доходы/расходы в request_financial_record:
   - type='Income' - доход от клиента
   - type='Expense' - расход контрагентам
7. При получении подтверждения оплаты:
   - Заполняет invoice_number, payment_date в финансовых записях
   - Система пересчитывает итоги
8. При необходимости изменения маршрута:
   - Supervisor возвращает: Approved → Negotiating
   - Ops редактирует route_stage
   - Переводит обратно: Negotiating → Approved
9. Когда груз доставлен и финансы в порядок:
   - Supervisor завершает: Approved → Completed
   - Заполняется request.completed_at

**Постусловие:** Запрос завершен (status='Completed'), все данные заполнены

---

### 3.3 Юзкейс 3: Logist согласует маршрут

**Актеры:** Logist, Sales/Ops  
**Предусловие:** Sales/Ops отправил запрос на согласование  
**Основной поток:**

1. Logist видит список маршрутов, которые требуют согласования
2. Открывает маршрут
3. Читает комментарий и файлы от Sales/Ops
4. Отвечает сообщением в чате:
   - Может согласиться с предложенным маршрутом
   - Или предложить альтернативу
   - Может задать уточняющие вопросы
5. Sales/Ops читает ответ и может:
   - Согласиться (закрыть согласование)
   - Отредактировать запрос и переотправить
6. После согласования Sales/Ops переводит запрос в статус Approved, Logist видит запрос как согласованный

**Постусловие:** Запрос согласован и переведен в статус Approved, Sales/Ops строит окончательный маршрут

---

### 3.4 Юзкейс 4: Supervisor формирует отчет

**Актеры:** Supervisor  
**Предусловие:** В системе накоплены данные по запросам и заказам  
**Основной поток:**

1. Supervisor выбирает "Формирование отчетов"
2. Выбирает критерии фильтрации:
   - По менеджеру (Sales/Ops)
   - По клиенту
   - По контрагенту
   - По направлению доставки
   - По периоду (дата создания/завершения)
   - По финансовым показателям
3. Система генерирует отчет с таблицей результатов
4. Supervisor может экспортировать отчет:
   - CSV (для Excel)
   - Excel (XLSX)
   - PDF (для печати)

**Постусловие:** Отчет сформирован и экспортирован

---

### 3.5 Юзкейс 5: Ops создает запрос с существующим клиентом

**Актеры:** Ops Manager  
**Предусловие:** В системе есть активный клиент (client.status='Active')  
**Основной поток:**

1. Ops выбирает "Создать новый запрос"
2. Выбирает существующего клиента из списка активных
3. Заполняет данные запроса:
   - Условия Incoterms
   - Отправитель и получатель
   - Точки отправления и назначения
   - Характеристики груза
   - Состав сборки (типы ТС)
   - Таможенные условия
4. Сохраняет запрос в статусе New
5. Заполняет route_stage (этапы маршрута):
   - Обычно использует типовой маршрут без согласования с Logist
   - Указывает плановые даты и стоимости
6. Переводит запрос: New → Approved (запрос становится заказом)
7. Ops начинает сопровождение заказа (см. Юзкейс 2)

**Альтернативные потоки:**
- Если маршрут нестандартный, Ops может отправить на согласование: New → Negotiating
- После согласования с Logist переводит: Negotiating → Approved

**Постусловие:** Запрос создан и переведен в заказ (status=Approved), Ops ведет сопровождение

---

### 3.6 Юзкейс 6: Supervisor изменяет маршрут выполняющегося заказа

**Актеры:** Supervisor, Ops Manager  
**Предусловие:** Заказ в статусе Approved, груз в пути, произошел форс-мажор или изменились условия  
**Основной поток:**

1. Ops или клиент сообщает о необходимости изменить маршрут
2. Supervisor открывает заказ (request.status='Approved')
3. Supervisor возвращает заказ на согласование: Approved → Negotiating
4. Ops или Sales редактирует route_stage:
   - Удаляет ненужные этапы
   - Добавляет новые этапы
   - Изменяет даты и стоимости
   - Корректирует порядок этапов (stage_order)
5. При необходимости согласовывает с Logist через route_negotiation чат
6. После согласования Ops/Sales информирует Supervisor
7. Supervisor проверяет изменения
8. Supervisor одобряет маршрут: Negotiating → Approved
9. Ops продолжает сопровождение с обновленным маршрутом

**Альтернативные потоки:**
- Если изменения не согласованы, Supervisor может отклонить: Negotiating → Rejected

**Постусловие:** Маршрут заказа изменен, заказ возвращен в статус Approved, сопровождение продолжается

---

## 4. Технологический стек

### 4.1 Backend Framework (требуется выбор)

**Вариант 1: Python + Django / Flask**
- Django REST Framework для API
- Celery для асинхронных операций (отправка уведомлений)
- Pillow для работы с изображениями

**Вариант 2: Node.js + Express / NestJS**
- Express для REST API
- NestJS для более структурированного подхода
- Multer для работы с файлами

**Вариант 3: ASP.NET Core (C#)**
- Entity Framework для работы с БД
- ASP.NET Core для REST API
- Swagger для документации API

### 4.2 Frontend Framework (требуется выбор)

**Вариант 1: React**
- React Router для навигации
- Redux / Zustand для state management
- Ant Design / Material-UI для UI компонентов
- Axios для HTTP запросов

**Вариант 2: Vue.js**
- Vue Router для навигации
- Vuex / Pinia для state management
- Vuetify / Element Plus для UI компонентов

**Вариант 3: Angular**
- RxJS для работы с асинхронностью
- Angular Material для UI компонентов
- HttpClientModule для API запросов

### 4.3 Database

- **СУБД:** MySQL 8.0+
- **Driver:** mysql2 / PyMySQL (зависит от backend)
- **ORM:** SQLAlchemy (Python) / TypeORM (Node) / Entity Framework (C#)

### 4.4 Хостинг и инфраструктура (рекомендации)

**Вариант 1: VPS + Docker**
- Docker контейнеры для Backend, Frontend, Database
- Docker Compose для оркестрации
- Nginx как reverse proxy
- Let's Encrypt для HTTPS

**Вариант 2: Cloud Platform**
- AWS (EC2, RDS, S3)
- Google Cloud (Compute Engine, Cloud SQL)
- Azure (App Service, Database for MySQL)

**Вариант 3: Managed Services (SaaS)**
- Heroku для Backend
- Vercel / Netlify для Frontend
- Managed MySQL (AWS RDS, Google Cloud SQL и т.д.)

---

## 5. Безопасность и доступ

### 5.1 Аутентификация

- **Метод:** Username + Password
- **Хеширование:** bcrypt (стандарт для паролей)
- **Аутентификация API:** JWT tokens (JSON Web Tokens)
  - Access Token: 8 часов (хранится в localStorage на фронтенде)
  - Refresh Token: 7 дней (для продления access token)
  - Передача: `Authorization: Bearer <token>` header
- **Библиотека PHP:** firebase/php-jwt
- **Архитектура:** REST API + отдельный фронтенд (React/Vue)

### 5.2 Авторизация (RBAC — Role-Based Access Control)

**Пять ролей:**
1. **Admin** — полный контроль системой
2. **Sales** — работа с лидами и запросами
3. **Ops** — работа с клиентами и заказами
4. **Logist** — согласование маршрутов
5. **Supervisor** — надзор и контроль

**Матрица доступа:** Полное описание прав для каждой роли смотрите в [specification.md, раздел 2 "Роли и права доступа"](specification.md#2-роли-и-права-доступа)

### 5.3 Валидация данных

- **На frontend:** клиентская валидация (UX)
- **На backend:** серверная валидация (безопасность)
- **Примеры:**
  - Email формат: regex pattern
  - Телефон: формат +7XXX XXX XXXX
  - ИНН: длина 12 символов
  - Даты: валидация диапазонов (договоры не должны быть истекшими)

### 5.4 Защита от атак

- **SQL Injection:** использование параметризованных запросов (PDO prepared statements)
- **XSS (Cross-Site Scripting):** экранирование выходных данных на фронтенде
- **HTTPS:** обязателен для всех соединений
- **Rate Limiting:** ограничение количества запросов от одного IP (например, 100 req/min)
- **JWT безопасность:**
  - Подпись сильным секретным ключом (HS256 алгоритм)
  - Проверка срока действия токена (exp claim)
  - Blacklist для отозванных токенов при logout

**Примечание:** CSRF защита не требуется при использовании JWT в Authorization header (не cookies)

### 5.5 Логирование и аудит

- **Простое текстовое логирование:** запись операций в .txt файл
- **Логируемые операции:**
  - Вход/выход пользователей
  - Создание/редактирование/удаление записей
  - Изменения статусов
  - Операции с финансами
- **Формат:** `[timestamp] [user] [action] [entity] [details]`
- **Ротация логов:** архивирование старых логов

---

## 6. Масштабируемость и производительность

### 6.1 Ожидаемые нагрузки

| Метрика | Значение |
|---------|----------|
| Запросов/заказов в месяц | 1000 |
| Документов в месяц | 3000 |
| Записей в таблице request в год | ~12,000 |
| Записей в таблице request_document в год | ~36,000 |
| Одновременно пользователей | ~25-30 |
| Среднее время отклика | ≤ 2 секунды |

### 6.2 Оптимизация БД

**Индексы:**
- PRIMARY KEY на id (все таблицы)
- FOREIGN KEY на связываемые поля
- INDEX на поля поиска: `name`, `inn`, `city`, `email`, `login`
- INDEX на поля фильтрации: `status`, `role`
- INDEX на поля сортировки: `created_at`, `updated_at`
- COMPOSITE INDEX на часто используемые комбинации

**Примеры:**
```sql
-- Поиск активных клиентов по имени
SELECT * FROM client WHERE name LIKE '%...%' AND status IN ('Lead', 'Active');
-- Используются индексы: idx_name, idx_status

-- Получение активных запросов конкретного Ops (New/Negotiating)
SELECT * FROM request WHERE initiator_id = ? AND status IN ('New', 'Negotiating');
-- Используются индексы: idx_initiator_id, idx_status

-- Получение заказов в работе (Approved)
SELECT * FROM request WHERE status = 'Approved';
-- Используется индекс: idx_status
```

### 6.3 Кеширование

- **Клиент-сайд:** кеширование в браузере
  - JWT токены (access_token, refresh_token)
  - Справочники (города, типы ТС, валюты)
  - Данные текущего пользователя в localStorage/sessionStorage
- **Сервер-сайд:** Redis для кеширования часто используемых данных (опционально)
  - Результаты отчетов
  - Справочники (cities, services и т.д.)
  - Данные текущего пользователя

### 6.4 Pagination (Разбиение на страницы)

- **Списки записей:** разбиение на страницы по 20-50 записей
- **LIMIT и OFFSET:** `SELECT * FROM request LIMIT 20 OFFSET 0`

### 6.5 Архивирование

- **Архивирование:** поскольку требуется хранить все данные неограниченно
- **Без удаления:** никогда не удаляются завершенные заказы
- **Фильтрация:** неактивные записи исключаются из поиска, но хранятся в БД

### 6.6 Масштабирование

**Вертикальное масштабирование (увеличение ресурсов одного сервера):**
- Увеличение RAM
- Более мощный CPU
- Faster SSD

**Горизонтальное масштабирование (добавление серверов):**
- Балансировка нагрузки (Load Balancer)
- Репликация БД (Master-Slave)
- Кеширование с Redis

---

## 7. REST API

**Полная спецификация:** [openapi.yaml](openapi.yaml) — 44 endpoints  
**Интерактивная документация:** [Swagger UI](https://aschum.github.io/loadstar-api-docs/)

**Все защищенные endpoints требуют:** `Authorization: Bearer <access_token>`

### 7.1 Аутентификация (примеры запросов)

**Логин:**
```http
POST /api/auth/login
Content-Type: application/json

{
  "login": "sales_manager",
  "password": "password123"
}

Response 200:
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "name": "Иван Иванов",
    "role": "Sales",
    "email": "ivan@loadstar.local"
  }
}
```

**Обновление токена:**
```http
POST /api/auth/refresh
Content-Type: application/json

{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}

Response 200:
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Logout:**
```http
POST /api/auth/logout
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

Response 200:
{
  "message": "Logged out successfully"
}
```

**Получение текущего пользователя:**
```http
GET /api/auth/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

Response 200:
{
  "id": 1,
  "name": "Иван Иванов",
  "role": "Sales",
  "email": "ivan@loadstar.local"
}
```

### 7.2 Основные группы endpoints

- **Authentication** (4 endpoints) — Аутентификация и управление токенами
  - Логин, логаут, обновление токена, получение информации о текущем пользователе

- **Users** (4 endpoints) — Управление пользователями
  - CRUD операции (только Admin), фильтрация по роли и статусу

- **Clients** (7 endpoints) — Управление клиентами и лидами
  - CRUD операции, управление контактами клиентов, поиск

- **Contragents** (8 endpoints) — Управление контрагентами
  - CRUD операции, управление контактами и договорами контрагентов

- **Requests** (8 endpoints) — Управление запросами
  - CRUD операции, управление файлами запросов, одобрение/отклонение

- **Route** (4 endpoints) — Согласование маршрутов
  - Управление этапами маршрута, чат согласования, изменение порядка этапов

- **Orders** (7 endpoints) — Управление заказами
  - Просмотр заказов, управление документами, счетами, договорами, финансовыми записями

- **Dictionaries** (2 endpoints) — Справочники системы
  - Получение всех справочников или конкретного (типы ТС, валюты, Incoterms, города, услуги)

- **Files** (2 endpoints) — Работа с файлами
  - Загрузка и скачивание файлов

- **Reports** (1 endpoint) — Отчеты и аналитика
  - Формирование отчетов по запросам с фильтрацией

---

## 8. Расписание разработки (рекомендуемо)

| Фаза | Длительность | Описание |
|------|-------------|----------|
| Фаза 1 | 2 недели | Подготовка окружения, setup backend + frontend, настройка БД |
| Фаза 2 | 3 недели | Аутентификация, управление пользователями, справочниками |
| Фаза 3 | 4 недели | Управление клиентами и контрагентами (CRUD) |
| Фаза 4 | 4 недели | Создание запросов, согласование маршрутов, чат |
| Фаза 5 | 3 недели | Построение окончательного маршрута, финализация запроса |
| Фаза 6 | 3 недели | Сопровождение заказов, ввод фактических данных |
| Фаза 7 | 2 недели | Финансовый учет, счета, доходы/расходы |
| Фаза 8 | 2 недели | Отчеты и аналитика |
| Фаза 9 | 1 неделя | Тестирование и отладка |
| Фаза 10 | 1 неделя | Развертывание и обучение пользователей |

**Итого:** ~25 недель (~6 месяцев)

---

## 9. Заключение

LoadStar — это комплексная система управления логистикой, спроектированная для компании среднего размера (25-30 пользователей) с географией операций по всему миру.

**Ключевые особенности:**
- Управление полным жизненным циклом: от Лида до завершенного Заказа
- Согласование маршрутов через чат с логистами
- Финансовый учет (счета клиентам, счета контрагентам, доходы/расходы)
- RBAC для пяти ролей
- Отчеты и аналитика
- MySQL 8.0+ для надежного хранения данных

**Следующие шаги:**
1. ✅ Утверждение ТЗ и архитектуры
2. Выбор технологического стека (Backend, Frontend)
3. Подготовка окружения разработки
4. Начало разработки согласно фазам

---

**Дата последнего обновления:** 13.02.2026  
**Версия документа:** 1.1
