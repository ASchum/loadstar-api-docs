# Техническое Задание (ТЗ)
## Система управления логистикой и заказами (LoadStar)

**Версия:** 1.1  
**Дата создания:** 5 февраля 2026  
**Последнее обновление:** 13 февраля 2026  
**Статус:** Проектирование  

---

## Содержание
1. [Общее описание системы](#1-общее-описание-системы)
2. [Роли и права доступа](#2-роли-и-права-доступа)
3. [Основные сущности и процессы](#3-основные-сущности-и-процессы)
4. [Бизнес-логика и переходы статусов](#4-бизнес-логика-и-переходы-статусов)
5. [Требования к функциям и интерфейсам](#5-требования-к-функциям-и-интерфейсам)
6. [Требования к безопасности и надежности](#6-требования-к-безопасности-и-надежности)
7. [Нефункциональные требования](#7-нефункциональные-требования)
8. [Ограничения и предположения](#8-ограничения-и-предположения)
9. [Критерии приемки](#9-критерии-приемки)
10. [История версий](#10-история-версий)

---

## 1. Общее описание системы

### 1.1 Назначение системы
LoadStar — корпоративная система управления логистическими операциями и заказами для компании, оказывающей услуги международной доставки грузов. Система предназначена для управления полным жизненным циклом заказа: от получения запроса до завершения доставки с учетом финансовых операций.

### 1.2 Масштаб и область применения
- **Тип системы:** Внутреннее корпоративное приложение (не SaaS)
- **Количество пользователей:** ~25-30 человек
  - Sales (менеджеры по продажам): ~5
  - Ops (операторы): ~10
  - Logist (логисты): ~3
  - Supervisor (супервизоры): ~2
  - Admin (администраторы): ~1
- **География операций:** Весь мир
- **Масштаб операций:** До 1000 запросов/заказов в месяц, до 3000 документов в месяц
- **Сроки разработки:** В соответствии с проектным планом

### 1.3 Основные процессы
Система поддерживает три основных процесса:
1. **Карточка Клиента/Контрагента** — управление справочниками
2. **Запрос (Request)** — обработка запроса от клиента (Лида) или существующего клиента
3. **Заказ (Order)** — исполнение заказа и учет финансов

---

## 2. Роли и права доступа

### 2.1 Роль: Admin (Администратор)
**Описание:** Управление системой, пользователями и справочниками.

**Права:**
- Добавление нового пользователя
- Редактирование данных пользователя (ФИО, роль, контакты, активность)
- Редактирование справочников (города, услуги, типы ТС, валюты, Incoterms и т.д.)
- Сброс паролей пользователей

**Доступ к функциям:** Только управление системой

---

### 2.2 Роль: Sales (Менеджер по продажам)
**Описание:** Работа с новыми потенциальными клиентами (Лидами) и преобразование их в заказы.

**Права:**
- Просмотр всех своих запросов (активные и завершенные)
- Создание нового запроса с вводом данных Лида
- Редактирование активного запроса
- Просмотр завершенного запроса (без редактирования)
- Согласование маршрута с логистом (инициация чата)
- Построение окончательного маршрута
- Перевод Лида в Клиента (заполнение недостающих данных)
- Перевод Запроса в Заказ (заключение договора)

**Доступ к данным:** Свои запросы, данные лидов, которых привел

---

### 2.3 Роль: Ops (Оператор)
**Описание:** Работа с существующими клиентами, создание и сопровождение заказов.

**Права:**
- Поиск клиента
- Поиск контрагента
- Редактирование данных клиента
- Редактирование данных контрагента
- Добавление нового клиента
- Добавление нового контрагента
- Просмотр всех своих запросов (активные и завершенные)
- Создание нового запроса
- Редактирование активного запроса
- Просмотр завершенного запроса
- Согласование маршрута с логистом
- Построение окончательного маршрута
- Перевод запроса в заказ
- Просмотр всех своих заказов (активные и завершенные)
- Редактирование (сопровождение) активного заказа:
  - Ввод фактических дат прохождения этапов
  - Загрузка документов
  - Ввод расходов и приходов денежных средств
- Выставление счета клиенту
- Запрос счета у контрагента
- Запрос на изменение маршрута
- Запрос на завершение заказа

**Доступ к данным:** Свои запросы и заказы, все клиенты и контрагенты

---

### 2.4 Роль: Logist (Логист)
**Описание:** Согласование маршрутов доставки и уточнение условий с операторами.

**Права:**
- Просмотр всех маршрутов (согласованные и несогласованные)
- Просмотр только несогласованных маршрутов
- Просмотр согласованного маршрута (без редактирования)
- Отправка ответа на несогласованный маршрут (через чат)

**Доступ к данным:** Все маршруты во всех запросах

---

### 2.5 Роль: Supervisor (Супервизор)
**Описание:** Надзор над всеми операциями, контроль и утверждение критических операций.

**Права:**
- Поиск и редактирование любого клиента
- Поиск и редактирование любого контрагента
- Добавление новых клиентов и контрагентов
- Просмотр всех запросов (активные и завершенные)
- Просмотр только активных запросов
- Создание нового запроса
- Редактирование активного запроса
- Просмотр завершенного запроса
- Перевод запроса в заказ
- Просмотр всех заказов (активные и завершенные)
- Просмотр только активных заказов
- Создание нового заказа (в особых случаях)
- Редактирование активного заказа
- Просмотр завершенного заказа
- Подтверждение завершения заказа (изменение статуса)
- Формирование отчетов по различным критериям
- Утверждение/отклонение запросов на изменение маршрута
- Изменение условий оплаты договора

**Доступ к данным:** Полный доступ ко всем данным системы

---

## 3. Основные сущности и процессы

### 3.1 Сущность: Пользователь (User)
**Описание:** Пользователь системы.

**Основные поля:**
- ФИО
- Роль (Admin, Sales, Ops, Logist, Supervisor)
- Телефон
- Email
- Логин
- Пароль (хешировано)
- Статус (Активный/Неактивный)
- Дата создания записи
- Дата последнего изменения

**Операции:**
- Добавление (Admin)
- Редактирование (Admin и сам пользователь)
- Деактивация (Admin)
- Просмотр (все пользователи)

---

### 3.2 Сущность: Контрагент (Contragent)
**Описание:** Партнеры компании для выполнения услуг (логистические компании, перевозчики, таможенные брокеры и т.д.).

**Основные поля:**
- Наименование (обязательно)
- ИНН (обязательно, валидация)
- Город
- Адрес
- Договоры (один или несколько):
  - Номер договора
  - Дата заключения
  - Дата окончания (валидация: должна быть в будущем, если договор активен)
  - Условия оплаты
  - Форма оплаты
- Направления перевозки (текст)
- Контактные лица (один или несколько):
  - ФИО
  - Должность
  - Email (валидация)
  - Телефон (валидация)
- Статус (Активный/Неактивный)

**Операции:**
- Добавление (Ops, Supervisor)
- Поиск по наименованию, ИНН, городу (Ops, Supervisor)
- Редактирование (Ops, Supervisor)
- Просмотр (все)
- Деактивация (Ops, Supervisor)

**Примечание:** Неактивные контрагенты не отображаются в списках для выбора.

---

### 3.3 Сущность: Клиент (Client)
**Описание:** Объединенная сущность для потенциальных клиентов (Лидов) и существующих клиентов компании. В базе данных хранится в одной таблице `client` с разделением по статусу.

**Статусы:**
- **Lead (Лид)** — потенциальный клиент, с которым работает Sales
- **Active (Активный клиент)** — действующий клиент компании
- **Inactive (Неактивный клиент)** — клиент, с которым временно не работаем

**Конвертация Лида в Клиента:**
Лид автоматически переводится в статус Active, когда его первый запрос переходит в статус Approved (становится заказом). При этом:
- `status` меняется: Lead → Active
- Заполняется поле `converted_at` (дата конвертации)
- Обязательно заполняются: ИНН, банковские реквизиты, ведущий менеджер

**Основные поля:**

**Общие поля (для всех статусов):**
- Наименование (обязательно) — для лида может быть именем контактного лица
- Город
- Адрес
- Направления перевозок (текст)
- С кем работают (текст)
- Что ценят (текст)
- Sales менеджер (выбор из Sales) — кто привел этого клиента
- Комментарий
- Дата создания
- Дата обновления

**Поля для статуса Lead (опциональные):**
- ИНН (может быть NULL, если ещё не известен)

**Поля для статуса Active/Inactive (обязательные):**
- ИНН (обязательно, валидация, уникальный)
- Банковские реквизиты:
  - Банк
  - Р/С (расчетный счет)
  - К/С (корреспондентский счет)
  - БИК
- Целевой объем перевозок в месяц (число)
- Ведущий менеджер (выбор из Ops)
- Дата конвертации лида (converted_at)

**Контактные лица (для всех статусов):**
- Текущие контакты (один или несколько):
  - ФИО
  - Должность
  - Email (валидация)
  - Телефон (валидация)
- ЛПР — Лица, принимающие решение (один или несколько):
  - ФИО
  - Должность
  - Email (валидация)
  - Телефон (валидация)

**Операции:**
- **Добавление:** Sales (создает Лидов), Ops/Supervisor (создают активных клиентов)
- **Поиск:** По наименованию, ИНН, городу, статусу
- **Редактирование:** Sales (свои лиды), Ops/Supervisor (все клиенты)
- **Просмотр:** Все
- **Изменение статуса:**
  - Lead → Active: автоматически при первом одобренном запросе
  - Active → Inactive: вручную (Ops, Supervisor)
  - Inactive → Active: вручную (Ops, Supervisor)

**Примечания:**
- Неактивные клиенты (Inactive) не отображаются в списках для выбора при создании новых запросов
- Лиды (Lead) доступны для выбора только Sales менеджерам
- Активные клиенты (Active) доступны для выбора всем (Ops, Sales, Supervisor)

---

### 3.4 Сущность: Запрос (Request)
**Описание:** Запрос на доставку груза. Может быть инициирован Sales (от Лида) или Ops (от существующего Клиента).

> **Примечание:** В базе данных это одна таблица `request` с полем `status`. Запрос (status: `New`/`Negotiating`/`Rejected`) превращается в Заказ (status: `Approved`/`Completed`) при одобрении. В API разделены на `/requests` и `/orders` для разных фаз жизненного цикла.

**Основные поля:**
- Тип запроса (От Sales с Лидом / От Ops с Клиентом)
- Инициатор (Sales или Ops)
- Клиент/Лид (связь)
- Дата создания
- Дата завершения или перевода в Заказ
- Статус (Активный/Завершен/Переведен в Заказ)
- Комментарий (если завершен, указать причину)

**Данные Запроса (Request Data) — основная информация:**
- Условия Incoterms (EXW, FCA, FOB, CIF, CIP, CPT, DAP)
- Отправитель (компания)
- Точка отправления (выбор из справочника или ручной ввод)
- Адрес отгрузки
- Получатель (компания)
- Точка назначения (выбор из справочника или ручной ввод)
- Адрес доставки
- Вид перевозки (выбор: море/море+жд/авиа/прямое ЖД/авто)
- Состав сборки (типы ТС и количество):
  - 20DC, 40DC, 40HC, 20RF, 40RF, 40FR, BreakBulk, LCL, еврофура, трал, LTL, авиагруз, полувагон, платформа, вагон
  - Хранение в БД: нормализованный список позиций (request 1:N request_transport_unit: vehicle_type + qty)
- Наименование груза
- Вес брутто (кг)
- Тяжелые места (от 1500 кг) — да/нет
- Таможенное оформление: Нашими силами (true) или Силами импортера (false)
- Место таможенного оформления
- Код ТН ВЭД
- Комментарий (многострочный, неструктурированный текст)
- Файлы (прикрепленные документы)
- Статус согласования маршрута с логистом (Не согласован/Согласован)

**Согласование маршрута (Route Negotiation) — чат между Sales/Ops и Logist:**
- Сообщения с датой, автором и текстом
- Первое сообщение от Sales/Ops инициирует согласование
- Logist отвечает уточняющей информацией
- Возможны несколько итераций согласования

**Окончательный маршрут (Final Route) — один маршрут на запрос:**
- Может редактироваться до момента пометки как "Окончательный"
- Состоит из этапов:
  - **Доставка (А → Б)** — один или несколько:
    - Контрагент
    - Пункт отправления
    - Пункт назначения
    - Услуга (морской фрахт, жд фрахт, авто, авиа, ПРР и т.д.)
    - Базовая сумма
    - Валюта базовой суммы
    - Конвертация (%)
    - Ставка клиенту (расчитанная)
    - Валюта ставки
    - Плановая дата отправления
    - Плановая дата прибытия
  - **Перегрузка** (если требуется):
    - Плановая дата перегрузки
  - **Таможня** (если требуется):
    - Плановая дата прибытия на таможню
    - Плановая дата прохождения таможни
    - Сумма таможенных сборов
    - Валюта
    - Конвертация (%)
  - **Склад** (конечная точка):
    - Плановая дата прибытия на склад

**Договор(ы) (на момент перевода в Заказ):**
- Номер договора
- Дата заключения
- Условия оплаты по договору
- Форма оплаты

**Операции:**
- Создание запроса (Sales, Ops, Supervisor)
- Редактирование активного запроса (Sales/Ops — свои, Supervisor — все)
- Просмотр запроса (Sales/Ops — свои, Supervisor — все, Logist — только маршрут)
- Согласование маршрута с логистом (Sales/Ops)
- Построение окончательного маршрута (Sales/Ops)
- Перевод Лида в Клиента (Sales)
- Перевод Запроса в Заказ (Sales/Ops/Supervisor)

---

### 3.5 Сущность: Заказ (Order)
**Описание:** Утвержденный заказ на доставку груза с полным циклом исполнения и финансовым учетом.

> **Примечание:** Заказ - это тот же Запрос (таблица `request`), но со статусом `Approved` или `Completed`. Разделение на Request/Order в API и документации носит концептуальный характер для удобства работы с разными функциями (согласование маршрута vs исполнение и финансы).

**Основные поля:**
- Исходящий Запрос (связь с Request)
- Клиент (связь)
- Основной способ перевозки
- Статус согласования (Заявка согласована / Ожидает согласования)
- Дата согласования
- Статус завершения (Заказ завершен / Заказ в процессе)
- Дата завершения (заполняется автоматически при завершении)
- Ведущий менеджер (Ops)
- Sales менеджер

**Маршрут в Заказе (Order Route):**
- Копия окончательного маршрута Запроса, расширенная фактическими данными
- **Доставка (А → Б):**
  - Плановые данные (из Request)
  - Фактическая дата отправления (заполняется Ops)
  - Фактическая дата прибытия (заполняется Ops)
  - Вычисляемые поля: задержка/опережение относительно плана
- **Перегрузка:**
  - Плановая дата
  - Фактическая дата перегрузки
  - Вычисляемые поля: задержка/опережение
- **Таможня:**
  - Плановые даты
  - Фактическая дата прибытия на таможню
  - Фактическая дата прохождения таможни
  - Номер ДТ (может быть несколько)
  - Вычисляемые поля: задержки/опережения
- **Склад:**
  - Плановая дата прибытия
  - Фактическая дата прибытия на склад
  - Вычисляемые поля: задержка/опережение

**Договор(ы) (один или несколько):**
- Номер договора
- Дата заключения
- Условия оплаты по договору
- Форма оплаты

**Документы:**
- Описание документа (Накладная, ДТ, Коносамент и т.д.)
- Прикрепленный файл

**Финансы:**
- **Счет клиенту (Invoice to Client):**
  - Отображается в виде текста с реквизитами клиента
  - Строки счета:
    - Описание услуги
    - Количество услуг
    - Цена за единицу
    - Итог (вычисляется)
- **Счет контрагенту (Invoice to Counterparty):**
  - Отображается в виде текста с реквизитами контрагента
  - Аналогично счету клиенту
- **Фактические доходы/расходы (Financial Records):**
  - Приход или Расход
  - Описание услуги
  - Количество услуг
  - Цена за единицу
  - Итог (вычисляется)
  - Номер счета (заполняется при получении подтверждения оплаты)
  - Дата оплаты
  - Комментарий (переплата/недоплата)
  - Нарастающий итог доходов/расходов

**Возможные операции на Заказе:**
- Выставление счета клиенту
- Запрос счета у контрагента
- Запрос на изменение маршрута (→ к Supervisor для утверждения)
- Запрос на завершение заказа (→ к Supervisor для утверждения)
- Ввод фактических дат (Ops)
- Загрузка документов (Ops)
- Ввод расходов/приходов (Ops)

**Запросы на изменение:**
- **Запрос на изменение маршрута:**
  - Инициирует Ops
  - Supervisor утверждает, изменяя статус "Окончательный маршрут" на "Нет"
  - Ops вносит изменения только в части без фактических дат
  - Ops помечает маршрут как окончательный снова
- **Запрос на завершение заказа:**
  - Инициирует Ops
  - Supervisor подтверждает, изменяя "Заказ завершен" на "Да"
  - Дата завершения заполняется автоматически
  - Заказ становится неактивным

---

## 4. Бизнес-логика и переходы статусов

### 4.1 Статусы запросов и заказов (request.status)

Запросы и заказы хранятся в одной таблице `request` и различаются статусом:

**Список статусов:**
1. **New** — новый запрос создан
2. **Negotiating** — согласование маршрута с логистом
3. **Approved** — одобрен, стал заказом, выполняется
4. **Completed** — завершен
5. **Rejected** — отклонен

**Диаграмма переходов:**
```
New ──────────────────────────→ Approved
 │                                  │
 │                                  │
 ├──→ Negotiating ──→ Approved ────┤
 │                                  │
 │                                  ↓
 └──────────────────────────→ Rejected
                                   ↑
         Approved ←─────────→ Negotiating (для изменения маршрута)
                                   │
                                   ↓
                              Completed
```

### 4.2 Права на изменение статусов запросов

| Переход | Кто может выполнить | Примечание |
|---------|---------------------|------------|
| New → Approved | Sales/Ops | Пропуск согласования, если маршрут готов |
| New → Negotiating | Sales/Ops | Отправка на согласование с логистом |
| Negotiating → Approved | Инициатор (Sales/Ops) | После согласования маршрута |
| Approved → Negotiating | **Только Supervisor** | Для изменения маршрута выполняющегося заказа |
| Approved → Completed | **Только Supervisor** | Завершение заказа |
| Любой → Rejected | Sales/Ops/Supervisor | Отклонение запроса/заказа |

### 4.3 Статусы клиентов (client.status)

**Список статусов:**
1. **Lead** — потенциальный клиент (лид)
2. **Active** — активный клиент
3. **Inactive** — неактивный клиент

**Переходы:**
- **Lead → Active**: Автоматически при переходе первого запроса в статус **Approved** (заполняется `client.converted_at`)
- **Active → Inactive**: Вручную (Ops, Supervisor) — клиент перестал работать с компанией
- **Inactive → Active**: Вручную (Ops, Supervisor) — возобновление сотрудничества

**Примечания:**
- Неактивные клиенты (Inactive) не отображаются в списках при создании новых запросов
- Лиды (Lead) доступны для выбора только Sales менеджерам
- Активные клиенты (Active) доступны всем (Sales, Ops, Supervisor)

### 4.4 Обязательные бизнес-правила

**При создании запроса:**
- `client_id` обязателен (Lead или Active клиент)
- `is_customs_by_us` обязателен (выбор: нашими силами или импортером)
- `initiator_id` устанавливается автоматически (текущий пользователь)

**При переходе New → Approved:**
- Маршрут (`route_stage`) должен содержать хотя бы 1 этап
- Состав сборки (`request_transport_unit`) должен содержать хотя бы 1 тип ТС
- Для Лида: автоматически меняется статус Lead → Active при первом Approved

**При переходе Approved → Negotiating:**
- Только Supervisor может вернуть заказ на доработку
- Используется для изменения маршрута выполняющегося заказа

**При переходе Approved → Completed:**
- Только Supervisor может завершить заказ
- Все этапы маршрута должны иметь фактические даты (опционально, для строгого контроля)
- Заполняется `completed_at` = NOW()

---

## 5. Требования к функциям и интерфейсам

### 5.1 Интерфейсы для Work Items (Карточки)

#### 5.1.1 Управление Пользователями (Admin)
- **Список пользователей:** таблица со всеми пользователями
- **Добавление пользователя:** форма с полями: ФИО, роль, телефон, email, логин, пароль
- **Редактирование пользователя:** редактирование всех полей
- **Деактивация:** смена статуса на "Неактивный"

#### 5.1.2 Управление Контрагентами (Ops, Supervisor)
- **Поиск контрагента:** поле поиска по наименованию, ИНН, городу
- **Список контрагентов:** результаты поиска (только активные при поиске)
- **Добавление контрагента:** форма со всеми полями
- **Карточка контрагента:** просмотр и редактирование
- **Договоры контрагента:** таблица договоров с кнопками добавления/редактирования/удаления
- **Контактные лица:** таблица контактов

#### 5.1.3 Управление Клиентами (Ops, Supervisor)
- **Поиск клиента:** поле поиска по наименованию, ИНН, городу
- **Список клиентов:** результаты поиска (только активные при поиске)
- **Добавление клиента:** форма со всеми полями
- **Карточка клиента:** просмотр и редактирование
- **Контакты и ЛПР:** таблицы контактов

#### 5.1.4 Управление Словарями (Admin)
- **Список справочников:** города, услуги, типы ТС, валюты, Incoterms, условия доставки и т.д.
- **Редактирование справочника:** добавление, удаление, изменение записей

---

### 5.2 Интерфейсы для Запросов (Request)

#### 5.2.1 Список Запросов (Sales, Ops, Supervisor, Logist)
- **Для Sales/Ops:** список своих запросов (активные отдельно, все запросы отдельно)
- **Для Supervisor:** список всех запросов (активные отдельно, все запросы отдельно)
- **Для Logist:** список всех маршрутов с фильтром по статусу согласования
- **Таблица:** номер запроса, инициатор, клиент/лид, дата создания, статус

#### 5.2.2 Создание Запроса
- **Выбор типа:** от Sales (с Лидом) или от Ops (с Клиентом)
- **Если от Sales:**
  - Ввод данных Лида (или выбор существующего)
  - Ввод Данных Запроса
  - Ввод Пожеланий Лида
  - Инициация согласования маршрута с Logist (загрузка комментария и файлов)
  - Переход к согласованию маршрута (чат с Logist)
- **Если от Ops:**
  - Выбор Клиента (поиск)
  - Ввод Данных Запроса
  - Ввод Пожеланий Клиента
  - Инициация согласования маршрута с Logist
  - Переход к согласованию маршрута (чат с Logist)

#### 5.2.3 Просмотр и Редактирование Запроса
- **Активный запрос:**
  - Просмотр всех данных
  - Редактирование (Sales/Ops — свои, Supervisor — все)
  - Вкладки:
    - "Основные данные" — Данные Запроса, информация о Клиенте/Лиде
    - "Согласование маршрута" — чат между Sales/Ops и Logist
    - "Окончательный маршрут" — построение и редактирование маршрута
    - "Договоры" — выбор договоров перед переводом в Заказ
- **Неактивный запрос:**
  - Просмотр без редактирования
  - Отображение причины завершения

#### 5.2.4 Согласование Маршрута (Sales/Ops + Logist)
- **Чат интерфейс:**
  - История сообщений с датой, авторами и текстом
  - Первое сообщение от Sales/Ops (с комментарием и файлами из Данных Запроса)
  - Ответ от Logist
  - Возможны несколько итераций
  - Статус "Маршрут согласован" — да/нет
- **Действия:**
  - Sales/Ops отправляет сообщение (инициирует согласование)
  - Sales/Ops может завершить согласование после ответа Logist
  - Logist может ответить на несогласованный маршрут

#### 5.2.5 Построение Окончательного Маршрута (Sales/Ops)
- **Интерфейс конструктора маршрута:**
  - Добавление этапов:
    - Доставка (А → Б)
    - Перегрузка
    - Таможня
    - Склад (финальная точка)
  - Для каждого этапа:
    - Выбор из справочников или ручной ввод
    - Вычисляемые поля (ставка клиенту на основе базовой суммы + маржа)
  - Кнопка "Сделать маршрут окончательным" (блокирует редактирование)
  - Статус "Окончательный маршрут" — да/нет

---

### 5.3 Интерфейсы для Заказов (Order)

#### 5.3.1 Список Заказов (Ops, Supervisor)
- **Для Ops:** список своих заказов (активные отдельно, все заказы отдельно)
- **Для Supervisor:** список всех заказов (активные отдельно, все заказы отдельно)
- **Таблица:** номер заказа, клиент, дата создания, статус, ведущий менеджер

#### 5.3.2 Просмотр и Редактирование Заказа (Ops)
- **Активный заказ:**
  - Редактирование (сопровождение):
    - Ввод фактических дат по этапам маршрута
    - Вычисление задержек/опережений
    - Загрузка документов (с описанием)
    - Ввод финансовых операций (расходы/приходы)
    - Ввод номера счета и даты оплаты
  - Вкладки:
    - "Маршрут" — плановые и фактические данные по этапам
    - "Документы" — прикрепленные файлы
    - "Финансы" — счета и операции
    - "История" — логирование изменений (если требуется)
- **Операции на Заказе:**
  - "Выставить счет" — открыть окно с текстом счета (реквизиты клиента + услуги)
  - "Запросить счет" — открыть окно с текстом счета контрагенту
  - "Запрос на изменение маршрута" — отправить запрос Supervisor
  - "Запрос на завершение заказа" — отправить запрос Supervisor

#### 5.3.3 Контроль Маршрута (Supervisor)
- **Запрос на изменение маршрута:**
  - Supervisor получает запрос от Ops
  - Может утвердить (маршрут снова становится редактируемым)
  - Ops вносит изменения
  - Ops помечает маршрут как окончательный снова
- **Запрос на завершение:**
  - Supervisor получает запрос от Ops
  - Может утвердить (дата завершения заполняется автоматически)
  - Заказ становится неактивным

#### 5.3.4 Управление Договорами на Заказе
- **Таблица договоров:**
  - Номер договора
  - Дата заключения
  - Условия оплаты
  - Форма оплаты
  - Возможность редактирования условий оплаты (Supervisor)

---

### 5.4 Отчеты и Статистика (Supervisor)
- **Формирование отчетов по:**
  - Менеджерам (Sales, Ops)
  - Клиентам
  - Контрагентам
  - Направлениям доставки
  - Датам (периодам)
  - Финансовым показателям (доходы, расходы, прибыль)
  - Задержкам/опережениям доставок
  - Категориям клиентов
- **Экспорт:** CSV, Excel, PDF

---

## 6. Требования к безопасности и надежности

### 6.1 Аутентификация и авторизация
- **Метод входа:** Username + Password
- **Хеширование паролей:** bcrypt (стандарт безопасности)
- **API аутентификация:** JWT tokens (JSON Web Tokens)
  - Access Token: срок действия 8 часов
  - Refresh Token: срок действия 7 дней
  - Передача токена: Authorization header (`Bearer <token>`)
- **Авторизация:** RBAC (Role-Based Access Control) по 5 ролям
- **Логирование:** запись всех входов/выходов в систему

### 6.2 Валидация данных
- Обязательные поля: проверка наличия значения
- Email: формат валидации
- Телефон: формат валидации (примеры: +7222 222 2222)
- ИНН: длина и формат
- Даты: валидация диапазонов (договоры не должны быть истекшими)

### 6.3 Хранение данных
- Хранение всех данных неограниченно
- Резервное копирование базы данных
- Восстановление после сбоев

### 6.4 Аудит (простое логирование)
- Простой текстовой логер (txt) для записи критических операций
- Логирование: кто, когда, что изменил (реализуется позже)

### 6.5 Контроль одновременного доступа (Optimistic Locking)

**Проблема:** Несколько пользователей могут одновременно редактировать одну запись (клиента, запрос, контрагента), что может привести к потере изменений.

**Решение:** Оптимистическая блокировка через поле `updated_at`

**Принцип работы:**
1. При GET запросе клиент получает `updated_at` (например, `"2026-02-13T10:00:00Z"`)
2. При PUT запросе клиент отправляет этот `updated_at` в теле запроса
3. Backend проверяет: если `updated_at` в БД отличается от переданного → конфликт (HTTP 409)
4. Клиент должен загрузить свежую версию данных и повторить редактирование

**Применяется к сущностям:**
- **Client** (клиенты) — критично, несколько менеджеров могут редактировать
- **Contragent** (контрагенты) — критично
- **Request** (запросы/заказы) — критично, Sales/Ops/Supervisor работают одновременно
- **User** (пользователи) — опционально, обычно редактирует только Admin

**Формат ошибки при конфликте:**
```json
{
  "error": "Conflict",
  "message": "Данные были изменены другим пользователем",
  "details": {
    "your_updated_at": "2026-02-13T10:00:00Z",
    "current_updated_at": "2026-02-13T14:30:00Z",
    "modified_by": "Иван Иванов"
  }
}
```

**SQL реализация:**
```sql
UPDATE client 
SET name = ?, city = ?, updated_at = NOW()
WHERE id = ? AND updated_at = ?;
-- Если affected_rows = 0 → конфликт (HTTP 409)
```

---

## 7. Нефункциональные требования

### 7.1 Производительность
- Система должна обрабатывать до 1000 запросов/заказов в месяц
- До 3000 документов в месяц
- Время отклика на типичный запрос: ≤ 2 секунды
- Одновременно могут работать до 30 пользователей

### 7.2 Масштабируемость
- Возможность расширения количества пользователей (предусмотреть резервы)
- Оптимизация БД индексами на часто используемые поля

### 7.3 Доступность
- Система должна быть доступна в рабочие часы
- Плановые технические работы — в нерабочее время

### 7.4 Технологический стек (планируемый)
- **СУБД:** MySQL
- **Backend:** (уточнить на следующем этапе)
- **Frontend:** (уточнить на следующем этапе)

---

## 8. Ограничения и предположения

### 8.1 Ограничения
- Система не интегрируется с внешними системами на этапе 1
- Отправка уведомлений по email будет добавлена позже
- Нет функции восстановления удаленных данных

### 8.2 Предположения
- Пользователи имеют базовые навыки работы с компьютером
- Имеется стабильное интернет-соединение
- Данные вводятся корректно (на входе валидация данных)
- Рабочий день: 09:00 - 18:00

---

## 9. Критерии приемки

### 9.1 Функциональные критерии
- ✓ Все основные CRUD операции для карточек реализованы
- ✓ Процесс "Запрос → Согласование маршрута → Заказ" полностью работает
- ✓ Все роли имеют правильные права доступа
- ✓ Финансовый учет работает корректно
- ✓ Отчеты генерируются корректно

### 9.2 Нефункциональные критерии
- ✓ БД работает без ошибок
- ✓ Система обрабатывает нагрузку из требований производительности
- ✓ Валидация данных работает корректно
- ✓ Система восстанавливается после ошибок

---

## 10. История версий

| Версия | Дата | Описание |
|--------|------|----------|
| 1.1 | 13.02.2026 | Обновлена терминология: Employee → User, добавлено содержание |
| 1.0 | 05.02.2026 | Первая версия ТЗ с полным описанием системы |

---

**Документ актуален на:** 13.02.2026
